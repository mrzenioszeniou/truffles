L.GridLayer.GoogleMutant=L.GridLayer.extend({includes:L.Mixin.Events,options:{minZoom:0,maxZoom:18,tileSize:256,subdomains:"abc",errorTileUrl:"",attribution:"",opacity:1,continuousWorld:!1,noWrap:!1,type:"roadmap",maxNativeZoom:21},initialize:function(options){L.GridLayer.prototype.initialize.call(this,options),this._ready=!!window.google&&!!window.google.maps&&!!window.google.maps.Map,this._tileCallbacks={},this._freshTiles={},this._imagesPerTile="hybrid"===this.options.type?2:1,this.createTile="hybrid"===this.options.type?this._createMultiTile:this._createSingleTile},onAdd:function(map){L.GridLayer.prototype.onAdd.call(this,map),this._initMutantContainer();var checkCounter=0,intervalId=null;intervalId=setInterval(function(){return checkCounter>=15?(console.log("window.google not found after "+checkCounter+" attempts"),clearInterval(intervalId),!1):window.google&&window.google.maps&&window.google.maps.Map?(this._ready=!0,this._map=map,this._initMutant(),map.on("viewreset",this._reset,this),map.on("move",this._update,this),map.on("zoomend",this._handleZoomAnim,this),map.on("resize",this._resize,this),map._controlCorners.bottomright.style.marginBottom="20px",this._reset(),this._update(),clearInterval(intervalId),!1):void checkCounter++}.bind(this),150)},onRemove:function(map){L.GridLayer.prototype.onRemove.call(this,map),map._container.removeChild(this._mutantContainer),this._mutantContainer=void 0,map.off("viewreset",this._reset,this),map.off("move",this._update,this),map.off("zoomend",this._handleZoomAnim,this),map.off("resize",this._resize,this),map._controlCorners.bottomright.style.marginBottom="0em"},getAttribution:function(){return this.options.attribution},setOpacity:function(opacity){this.options.opacity=opacity,opacity<1&&L.DomUtil.setOpacity(this._mutantContainer,opacity)},setElementSize:function(e,size){e.style.width=size.x+"px",e.style.height=size.y+"px"},_initMutantContainer:function(){this._mutantContainer||(this._mutantContainer=L.DomUtil.create("div","leaflet-google-mutant leaflet-top leaflet-left"),this._mutantContainer.id="_MutantContainer_"+L.Util.stamp(this._mutantContainer),this._mutantContainer.style.pointerEvents="none",this._map.getContainer().appendChild(this._mutantContainer)),this.setOpacity(this.options.opacity),this.setElementSize(this._mutantContainer,this._map.getSize()),this._attachObserver(this._mutantContainer)},_initMutant:function(){if(this._ready&&this._mutantContainer){this._mutantCenter=new google.maps.LatLng(0,0);var map=new google.maps.Map(this._mutantContainer,{center:this._mutantCenter,zoom:0,tilt:0,mapTypeId:this.options.type,disableDefaultUI:!0,keyboardShortcuts:!1,draggable:!1,disableDoubleClickZoom:!0,scrollwheel:!1,streetViewControl:!1,styles:this.options.styles||{},backgroundColor:"transparent"});this._mutant=map,this.fire("spawned",{mapObject:map})}},_attachObserver:function(node){var observer=new MutationObserver(this._onMutations.bind(this));observer.observe(node,{childList:!0,subtree:!0})},_onMutations:function(mutations){for(var i=0;i<mutations.length;++i)for(var mutation=mutations[i],j=0;j<mutation.addedNodes.length;++j){var node=mutation.addedNodes[j];node instanceof HTMLImageElement?this._onMutatedImage(node):node instanceof HTMLElement&&Array.prototype.forEach.call(node.querySelectorAll("img"),this._onMutatedImage.bind(this))}},_roadRegexp:/!1i(\d+)!2i(\d+)!3i(\d+)!/,_satRegexp:/x=(\d+)&y=(\d+)&z=(\d+)/,_staticRegExp:/StaticMapService\.GetMapImage/,_onMutatedImage:function(imgNode){var coords,sublayer,parent,match=imgNode.src.match(this._roadRegexp);if(match?(coords={z:match[1],x:match[2],y:match[3]},this._imagesPerTile>1&&(imgNode.style.zIndex=1),sublayer=1):(match=imgNode.src.match(this._satRegexp),match&&(coords={x:match[1],y:match[2],z:match[3]}),sublayer=0),coords){var key=this._tileCoordsToKey(coords);this._imagesPerTile>1&&(key+="/"+sublayer),key in this._tileCallbacks&&this._tileCallbacks[key]?(this._tileCallbacks[key].pop()(imgNode),this._tileCallbacks[key].length||delete this._tileCallbacks[key]):(parent=imgNode.parentNode,parent&&(parent.removeChild(imgNode),parent.removeChild=L.Util.falseFn),key in this._freshTiles?this._freshTiles[key].push(imgNode):this._freshTiles[key]=[imgNode])}else imgNode.src.match(this._staticRegExp)&&(parent=imgNode.parentNode,parent&&imgNode.parentNode.replaceChild(L.DomUtil.create("img"),imgNode))},_createSingleTile:function(coords,done){var key=this._tileCoordsToKey(coords);if(key in this._freshTiles){var tile=this._freshTiles[key].pop();return this._freshTiles[key].length||delete this._freshTiles[key],L.Util.requestAnimFrame(done),tile}var tileContainer=L.DomUtil.create("div");return this._tileCallbacks[key]=this._tileCallbacks[key]||[],this._tileCallbacks[key].push(function(c){return function(imgNode){var parent=imgNode.parentNode;parent&&(parent.removeChild(imgNode),parent.removeChild=L.Util.falseFn),c.appendChild(imgNode),done()}.bind(this)}.bind(this)(tileContainer)),tileContainer},_createMultiTile:function(coords,done){var key=this._tileCoordsToKey(coords),tileContainer=L.DomUtil.create("div");tileContainer.dataset.pending=this._imagesPerTile;for(var i=0;i<this._imagesPerTile;i++){var key2=key+"/"+i;key2 in this._freshTiles?(tileContainer.appendChild(this._freshTiles[key2].pop()),this._freshTiles[key2].length||delete this._freshTiles[key2],tileContainer.dataset.pending--):(this._tileCallbacks[key2]=this._tileCallbacks[key2]||[],this._tileCallbacks[key2].push(function(c){return function(imgNode){var parent=imgNode.parentNode;parent&&(parent.removeChild(imgNode),parent.removeChild=L.Util.falseFn),c.appendChild(imgNode),c.dataset.pending--,parseInt(c.dataset.pending)||done()}.bind(this)}.bind(this)(tileContainer)))}return parseInt(tileContainer.dataset.pending)||L.Util.requestAnimFrame(done),tileContainer},_checkZoomLevels:function(){void 0!==this._map.getZoom()&&this._mutant.getZoom()!==this._map.getZoom()&&this._map.setZoom(this._mutant.getZoom())},_reset:function(){this._initContainer()},_update:function(){if(L.GridLayer.prototype._update.call(this),this._mutant){var center=this._map.getCenter(),_center=new google.maps.LatLng(center.lat,center.lng);this._mutant.setCenter(_center);var zoom=this._map.getZoom();void 0!==zoom&&this._mutant.setZoom(Math.round(this._map.getZoom()))}},_resize:function(){var size=this._map.getSize();this._mutantContainer.style.width===size.x&&this._mutantContainer.style.height===size.y||(this.setElementSize(this._mutantContainer,size),this._mutant&&google.maps.event.trigger(this._mutant,"resize"))},_handleZoomAnim:function(){var center=this._map.getCenter(),_center=new google.maps.LatLng(center.lat,center.lng);this._mutant.setCenter(_center),this._mutant.setZoom(Math.round(this._map.getZoom()))},_removeTile:function(key){if(this._imagesPerTile>1)for(var i=0;i<this._imagesPerTile;i++){var key2=key+"/"+i;key2 in this._freshTiles&&delete this._freshTiles[key2]}else key in this._freshTiles&&delete this._freshTiles[key];return L.GridLayer.prototype._removeTile.call(this,key)}}),L.gridLayer.googleMutant=function(options){return new L.GridLayer.GoogleMutant(options)};